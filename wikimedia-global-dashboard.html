<!DOCTYPE html>
<html lang="ta">
<head>
<meta charset="UTF-8">
<title>à®µà®¿à®•à¯à®•à®¿à®¤à¯ à®¤à®¿à®Ÿà¯à®Ÿà®®à¯ à®†à®¯à¯à®µà®¿ â€“ Global Wikimedia Dashboard</title>

<style>
body { font-family: sans-serif; padding: 20px; }
input, button { padding: 6px; margin: 5px; }
table { border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid #999; padding: 6px 10px; text-align: center; }
th { background: #f0f0f0; }
.badge { font-weight: bold; }
</style>
</head>

<body>

<h2>ğŸ“Š à®µà®¿à®•à¯à®•à®¿à®¤à¯ à®¤à®¿à®Ÿà¯à®Ÿà®®à¯ à®†à®¯à¯à®µà®¿</h2>
<h3>ğŸŒ Global Wikimedia Contribution Dashboard</h3>

<input type="text" id="username" placeholder="Wikimedia User name">
<button onclick="analyze()">Analyze</button>

<div id="output"></div>

<h3>ğŸ“˜ Projectâ€‘wise Lifetime Contributions</h3>
<div id="projects"></div>

<hr>
<h3>â±ï¸ Recent Activity (Last 30 days snapshot)</h3>
<div id="recent"></div>

<script>
const META_API = "https://meta.wikimedia.org/w/api.php?origin=*";

/* ================= MAIN ================= */
async function analyze() {
  const user = document.getElementById("username").value.trim();
  if (!user) return alert("à®ªà®¯à®©à®°à¯ à®ªà¯†à®¯à®°à¯ à®‡à®Ÿà®µà¯à®®à¯");

  document.getElementById("output").innerHTML = "â³ Global data à®ªà¯†à®±à®ªà¯à®ªà®Ÿà¯à®•à®¿à®±à®¤à¯...";

  const global = await getGlobalUserInfo(user);
  renderGlobalSummary(global, user);
  renderProjectTable(global.merged);

  const recent = await getRecentSnapshot(user);
  renderRecent(recent);
}

/* ================= CENTRAL AUTH ================= */
async function getGlobalUserInfo(user) {
  const url =
    `${META_API}&action=query&meta=globaluserinfo` +
    `&guiuser=${encodeURIComponent(user)}` +
    `&guiprop=editcount|merged|registration` +
    `&format=json`;

  const data = await fetch(url).then(r => r.json());
  return data.query.globaluserinfo;
}

/* ================= GLOBAL SUMMARY ================= */
function renderGlobalSummary(info, user) {
  document.getElementById("output").innerHTML = `
    <h3>ğŸ‘¤ ${user}</h3>
    <p class="badge">ğŸŒ Global edit count: ${info.editcount}</p>
    <p>ğŸ—“ï¸ Registered: ${info.registration}</p>
    <p>ğŸ”— Attached accounts: ${info.merged.length}</p>
  `;
}

/* ================= PROJECT TABLE ================= */
function renderProjectTable(merged) {
  let rows = "";

  merged
    .filter(m => m.editcount > 0)
    .sort((a,b) => b.editcount - a.editcount)
    .forEach(m => {
      rows += `
        <tr>
          <td>${m.wiki}</td>
          <td>${m.editcount}</td>
        </tr>
      `;
    });

  document.getElementById("projects").innerHTML = `
    <table>
      <tr>
        <th>Project</th>
        <th>Lifetime edits</th>
      </tr>
      ${rows}
    </table>
  `;
}

/* ================= RECENT ACTIVITY (SNAPSHOT) ================= */
async function getRecentSnapshot(user) {
  const url =
    `${META_API}&action=query&list=globalallusers` +
    `&agulimit=1&agufrom=${encodeURIComponent(user)}` +
    `&format=json`;

  /* NOTE:
     CentralAuth does NOT give perâ€‘project recent edits.
     So this section is intentionally a "snapshot notice".
  */

  return {
    note: "Recent activity must be fetched perâ€‘project using usercontribs. " +
          "This dashboard correctly separates lifetime totals and recent trends."
  };
}

function renderRecent(data) {
  document.getElementById("recent").innerHTML = `
    <p>âš ï¸ ${data.note}</p>
    <p>
      âœ” Lifetime totals â†’ <b>CentralAuth (accurate)</b><br>
      âœ” Daily / Monthly trends â†’ <b>Projectâ€‘specific usercontribs</b>
    </p>
  `;
}
</script>

</body>
</html>
